
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ツリー型ページリスト – 子ページ確実表示</title>
<style>
body{font-family:sans-serif;background:#f7f7f7;margin:0;padding:1rem;}
h1{text-align:center;}
#tree{margin:0;padding:0;}
li{list-style:none;position:relative;padding:4px 28px 4px 1.5em;border-radius:4px;margin:2px 0;transition:background .2s;}
li:hover{background:#eaeaea;}
li::before{content:'▶';position:absolute;left:0;top:6px;font-size:0.8rem;cursor:pointer;color:#666;}
li.open::before{content:'▼';}
li.leaf::before{content:'';}            /* 矢印を消すだけ */
span.title{cursor:pointer;}
button.add{position:absolute;right:4px;top:2px;border:none;background:transparent;font-size:1rem;cursor:pointer;color:#4caf50;}
ul{margin:0 0 0 1em;padding-left:0;display:none;}
li.open>ul{display:block;}              /* open クラスで展開 */
#rootAdd{display:block;margin:1rem auto;border:none;background:#4caf50;color:#fff;padding:0.5rem 1rem;font-size:1rem;border-radius:4px;cursor:pointer;}
</style>
</head>
<body>
<h1>ツリー型ページリスト – 修正版</h1>

<button id="rootAdd">＋ 新しいページを追加</button>
<ul id="tree"></ul>

<script>
let idCounter = 0;
const pages = [];                            // {id,title,children,open}

function createLi(node){
  const li = document.createElement('li');
  li.dataset.id = node.id;
  if(node.children.length===0) li.classList.add('leaf');
  if(node.open)                li.classList.add('open');

  // --- 可視要素 ---
  const title = document.createElement('span');
  title.className = 'title';
  title.textContent = node.title;
  li.appendChild(title);

  const add = document.createElement('button');
  add.className = 'add';
  add.textContent = '+';
  li.appendChild(add);

  const ul  = document.createElement('ul');
  li.appendChild(ul);

  // --- 開閉 ---
  const toggle = () => {
    if(node.children.length){
      node.open = !node.open;
      redraw();
    }
  };
  title.onclick = toggle;
  li.onclick    = e=>{ if(e.target===li) toggle(); };

  // --- 子追加 ---
  add.onclick = e=>{
    e.stopPropagation();
    const name = prompt('新しいページ名:');
    if(!name) return;
    node.children.push({id:++idCounter,title:name,children:[],open:false});
    node.open = true;              // 親を展開
    redleafFix(li);                // ← ここで leaf→枝 にする
    redraw();
  };

  return {li,ul};
}

function redleafFix(li){
  if(li.classList.contains('leaf')){
    li.classList.remove('leaf');   // ★ これで矢印も復活
    li.classList.add('open');
  }
}

function render(nodes, parent){
  parent.innerHTML = '';
  nodes.forEach(n=>{
    const {li,ul} = createLi(n);
    parent.appendChild(li);
    render(n.children, ul);
  });
}

function redraw(){ render(pages, document.getElementById('tree')); }

document.getElementById('rootAdd').onclick = ()=>{
  const name = prompt('新しいページ名:');
  if(!name) return;
  pages.push({id:++idCounter,title:name,children:[],open:false});
  redraw();
};

redraw();
</script>
</body>
</html>
